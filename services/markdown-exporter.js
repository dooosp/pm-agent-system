function escapeMarkdown(str) {
  if (typeof str !== 'string') return String(str || '');
  return str.replace(/\|/g, '\\|').replace(/`/g, '\\`');
}

function toMarkdown(documentType, document, objectionHandling) {
  switch (documentType) {
    case 'prd': return prdToMarkdown(document);
    case 'one-pager': return onePagerToMarkdown(document);
    case 'briefing': return briefingToMarkdown(document);
    default: return `# Document\n\n\`\`\`json\n${JSON.stringify(document, null, 2)}\n\`\`\``;
  }
}

function prdToMarkdown(doc) {
  const lines = [];
  lines.push(`# ${doc.title || 'PRD'}`);
  lines.push(`> Version: ${doc.version || '1.0'} | Author: ${doc.author || 'PM Agent'} | Date: ${doc.date || ''} | Status: ${doc.status || 'Draft'}`);
  lines.push('');

  if (doc.overview) {
    lines.push('## 1. Overview');
    lines.push(`**Problem:** ${doc.overview.problem}`);
    lines.push(`**Solution:** ${doc.overview.solution}`);
    if (doc.overview.goals?.length) {
      lines.push('### Goals');
      doc.overview.goals.forEach(g => lines.push(`- ${g}`));
    }
    lines.push('');
  }

  if (doc.successMetrics?.length) {
    lines.push('## 2. Success Metrics');
    lines.push('| Metric | Current | Target | Measurement |');
    lines.push('|--------|---------|--------|-------------|');
    doc.successMetrics.forEach(m =>
      lines.push(`| ${escapeMarkdown(m.metric)} | ${escapeMarkdown(m.current)} | ${escapeMarkdown(m.target)} | ${escapeMarkdown(m.measurement)} |`)
    );
    lines.push('');
  }

  if (doc.userStories?.length) {
    lines.push('## 3. User Stories');
    doc.userStories.forEach(us => {
      lines.push(`### ${us.id} [${us.priority || 'P1'}]`);
      lines.push(`**Persona:** ${us.persona}`);
      lines.push(`> ${escapeMarkdown(us.story)}`);
      if (us.acceptanceCriteria?.length) {
        lines.push('**Acceptance Criteria:**');
        us.acceptanceCriteria.forEach(ac => lines.push(`- [ ] ${ac}`));
      }
      lines.push('');
    });
  }

  if (doc.scope) {
    lines.push('## 4. Scope');
    if (doc.scope.inScope?.length) {
      lines.push('### In Scope');
      doc.scope.inScope.forEach(s => lines.push(`- ${s}`));
    }
    if (doc.scope.outOfScope?.length) {
      lines.push('### Out of Scope');
      doc.scope.outOfScope.forEach(s => lines.push(`- ${s}`));
    }
    if (doc.scope.assumptions?.length) {
      lines.push('### Assumptions');
      doc.scope.assumptions.forEach(s => lines.push(`- ${s}`));
    }
    lines.push('');
  }

  if (doc.technicalRequirements) {
    const tr = doc.technicalRequirements;
    lines.push('## 5. Technical Requirements');
    if (tr.architecture) lines.push(`**Architecture:** ${tr.architecture}`);
    if (tr.integrations?.length) {
      lines.push('### Integrations');
      tr.integrations.forEach(i => lines.push(`- ${i}`));
    }
    if (tr.constraints?.length) {
      lines.push('### Constraints');
      tr.constraints.forEach(c => lines.push(`- ${c}`));
    }
    if (tr.securityConsiderations?.length) {
      lines.push('### Security');
      tr.securityConsiderations.forEach(s => lines.push(`- ${s}`));
    }
    lines.push('');
  }

  if (doc.timeline?.phases?.length) {
    lines.push('## 6. Timeline');
    doc.timeline.phases.forEach(p => {
      lines.push(`### ${p.phase} (${p.duration || 'TBD'})`);
      lines.push(p.description);
      if (p.deliverables?.length) {
        lines.push('**Deliverables:**');
        p.deliverables.forEach(d => lines.push(`- ${d}`));
      }
      lines.push('');
    });
  }

  if (doc.openQuestions?.length) {
    lines.push('## 7. Open Questions');
    doc.openQuestions.forEach(q => lines.push(`- [ ] ${q}`));
    lines.push('');
  }

  lines.push('---');
  lines.push('*Generated by PM Agent System*');
  return lines.join('\n');
}

function onePagerToMarkdown(doc) {
  const lines = [];
  lines.push(`# ${doc.title || 'One-Pager'}`);
  lines.push(`> Date: ${doc.date || ''}`);
  lines.push('');

  if (doc.executiveSummary) {
    lines.push(`**${doc.executiveSummary}**`);
    lines.push('');
  }

  if (doc.problem) {
    lines.push('## Problem');
    lines.push(`- **Statement:** ${doc.problem.statement}`);
    lines.push(`- **Impact:** ${doc.problem.impact}`);
    lines.push(`- **Urgency:** ${doc.problem.urgency}`);
    lines.push('');
  }

  if (doc.solution) {
    lines.push('## Solution');
    lines.push(`**Approach:** ${doc.solution.approach}`);
    if (doc.solution.keyActions?.length) {
      lines.push('### Key Actions');
      doc.solution.keyActions.forEach(a => lines.push(`- ${a}`));
    }
    if (doc.solution.differentiator) lines.push(`\n**Why this approach:** ${doc.solution.differentiator}`);
    lines.push('');
  }

  if (doc.expectedOutcome) {
    lines.push('## Expected Outcome');
    lines.push(`- **Short-term (3M):** ${doc.expectedOutcome.shortTerm}`);
    lines.push(`- **Long-term (1Y):** ${doc.expectedOutcome.longTerm}`);
    if (doc.expectedOutcome.metrics?.length) {
      lines.push('### KPIs');
      doc.expectedOutcome.metrics.forEach(m => lines.push(`- ${m}`));
    }
    lines.push('');
  }

  if (doc.investment) {
    lines.push('## Investment');
    lines.push(`- **Resources:** ${doc.investment.resources}`);
    lines.push(`- **Timeline:** ${doc.investment.timeline}`);
    if (doc.investment.cost) lines.push(`- **Cost:** ${doc.investment.cost}`);
    lines.push('');
  }

  if (doc.risks) {
    lines.push('## Risks');
    lines.push(`- **Top Risk:** ${doc.risks.topRisk}`);
    lines.push(`- **Mitigation:** ${doc.risks.mitigation}`);
    lines.push('');
  }

  if (doc.ask) {
    lines.push('## Ask');
    lines.push(`**Decision needed:** ${doc.ask.decision}`);
    if (doc.ask.deadline) lines.push(`**Deadline:** ${doc.ask.deadline}`);
    if (doc.ask.nextSteps?.length) {
      lines.push('### Next Steps');
      doc.ask.nextSteps.forEach(s => lines.push(`1. ${s}`));
    }
    lines.push('');
  }

  lines.push('---');
  lines.push('*Generated by PM Agent System*');
  return lines.join('\n');
}

function briefingToMarkdown(doc) {
  const lines = [];
  lines.push(`# ${doc.title || 'Stakeholder Briefing'}`);
  lines.push(`> Date: ${doc.date || ''}`);
  lines.push('');

  if (doc.context) {
    lines.push(`${doc.context}`);
    lines.push('');
  }

  if (doc.stakeholderBriefings?.length) {
    lines.push('## Stakeholder Briefings');
    doc.stakeholderBriefings.forEach(sb => {
      lines.push(`### ${sb.stakeholder}`);
      lines.push(`**Key Message:** ${sb.keyMessage}`);
      if (sb.relevantPoints?.length) {
        sb.relevantPoints.forEach(p => lines.push(`- ${p}`));
      }
      lines.push(`**Call to Action:** ${sb.callToAction}`);
      lines.push('');
    });
  }

  if (doc.talkingPoints?.length) {
    lines.push('## Talking Points');
    doc.talkingPoints.forEach(tp => lines.push(`- ${tp}`));
    lines.push('');
  }

  if (doc.doNotMention?.length) {
    lines.push('## Do Not Mention');
    doc.doNotMention.forEach(d => lines.push(`- ~~${d}~~`));
    lines.push('');
  }

  lines.push('---');
  lines.push('*Generated by PM Agent System*');
  return lines.join('\n');
}

module.exports = { toMarkdown };
